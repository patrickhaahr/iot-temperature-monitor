<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Temperature Monitor - Service Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <nav class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">Service Menu</h1>
                <a href="/" class="text-blue-600 hover:text-blue-800">Back to Dashboard</a>
            </div>
        </nav>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- System Settings -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">System Settings</h2>
                <form id="settingsForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Temperature Update Interval (seconds)</label>
                        <input type="number" name="tempUpdateInterval" placeholder="5" min="1" max="60"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <p class="mt-1 text-sm text-gray-500">How often the temperature display updates. Lower values (1-5s) give more frequent updates but use more power. Default: 5s</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Logging Interval (seconds)</label>
                        <input type="number" name="loggingInterval" placeholder="300" min="5" max="3600"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <p class="mt-1 text-sm text-gray-500">How often readings are saved to storage. Higher values (300-3600s) save storage space. Default: 300s (5 min)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Maximum Log Entries</label>
                        <input type="number" name="maxLogEntries" placeholder="1000" min="100" max="10000"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <p class="mt-1 text-sm text-gray-500">Maximum number of readings to keep in storage. Higher values keep longer history but use more storage. Default: 1000</p>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Save Settings
                    </button>
                </form>
            </div>

            <!-- Data Management -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">Data Management</h2>
                <div class="space-y-4">
                    <div>
                        <button id="exportData" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                            Export Temperature Data
                        </button>
                    </div>
                    <div>
                        <button id="resetWifi" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                            Reset WiFi Configuration
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="statusMessage" class="fixed bottom-4 right-4 hidden">
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
            <span class="block sm:inline" id="statusText"></span>
        </div>
    </div>

    <script>
        // Load current settings
        async function loadSettings() {
            try {
                const response = await fetch('/api/system/settings');
                const settings = await response.json();
                
                document.querySelector('[name="tempUpdateInterval"]').value = settings.tempUpdateInterval;
                document.querySelector('[name="loggingInterval"]').value = settings.loggingInterval;
                document.querySelector('[name="maxLogEntries"]').value = settings.maxLogEntries;
            } catch (error) {
                showStatus('Failed to load settings', 'error');
            }
        }

        // Save settings
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const settings = {
                tempUpdateInterval: parseInt(document.querySelector('[name="tempUpdateInterval"]').value),
                loggingInterval: parseInt(document.querySelector('[name="loggingInterval"]').value),
                maxLogEntries: parseInt(document.querySelector('[name="maxLogEntries"]').value)
            };

            // Validate settings
            if (settings.tempUpdateInterval < 1 || settings.tempUpdateInterval > 60) {
                showStatus('Temperature update interval must be between 1-60 seconds', 'error');
                return;
            }
            if (settings.loggingInterval < 5 || settings.loggingInterval > 3600) {
                showStatus('Logging interval must be between 5-3600 seconds', 'error');
                return;
            }
            if (settings.maxLogEntries < 100 || settings.maxLogEntries > 10000) {
                showStatus('Max log entries must be between 100-10000', 'error');
                return;
            }

            try {
                const response = await fetch('/api/system/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showStatus('Settings saved successfully');
                } else {
                    showStatus(result.message || 'Failed to save settings', 'error');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showStatus('Failed to save settings: Network error', 'error');
            }
        });

        // Export data
        document.getElementById('exportData').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/data/export');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'temperature_data.json';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showStatus('Data exported successfully');
                } else {
                    showStatus('Failed to export data', 'error');
                }
            } catch (error) {
                showStatus('Failed to export data', 'error');
            }
        });

        // Reset WiFi
        document.getElementById('resetWifi').addEventListener('click', async () => {
            if (confirm('Are you sure you want to reset the WiFi configuration? The device will restart in AP mode.')) {
                try {
                    const response = await fetch('/api/system/reset', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        showStatus('WiFi configuration reset. Device will restart...');
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 3000);
                    } else {
                        showStatus('Failed to reset WiFi configuration', 'error');
                    }
                } catch (error) {
                    showStatus('Failed to reset WiFi configuration', 'error');
                }
            }
        });

        // Show status message
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('statusMessage');
            const statusText = document.getElementById('statusText');
            statusText.textContent = message;
            
            statusDiv.classList.remove('hidden');
            statusDiv.firstElementChild.className = type === 'success' 
                ? 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative'
                : 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative';
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }

        // Load settings when page loads
        loadSettings();
    </script>
</body>
</html> 